<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokens</title>
    <link href="./bootstrap-5.3.0.min.css" rel="stylesheet">
    <script src="./jquery-3.7.1.min.js"></script>
    <style>
        @media (max-width: 768px) {
            .table thead {
                display: none;
            }

            .table, .table tbody, .table tr, .table td {
                display: block;
                width: 100%;
            }

                .table tr {
                    margin-bottom: 5px;
                }

                .table td {
                    text-align: right;
                    padding-left: 15px;
                    position: relative;
                }

                    .table td::before {
                        content: attr(data-label);
                        position: absolute;
                        left: 5px;
                        font-weight: bold;
                        text-align: left;
                        white-space: nowrap;
                    }
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div id="statusMessage" class="alert" style="display: none;"></div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Identity</th>
                    <th>Key</th>
                    <th>Value</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tokenTableBody">
                <!-- Dynamic rows will be inserted here -->
            </tbody>
        </table>
        <button id="addRow" class="btn btn-secondary">Add Row</button>
        <button id="refresh" class="btn btn-secondary">Refresh</button>
        <button id="submit" class="btn btn-primary">Submit</button>
    </div>

    <script>
        (function () {
            // UI
            function showStatusMessage(message, type) {
                $('#statusMessage').removeClass('alert-success alert-danger').addClass('alert-' + type).text(message).show();
            }

            function clearStatusMessage() {
                $('#statusMessage').hide().text('');
            }

            function addRow() {
                clearStatusMessage();
                $('#tokenTableBody').append(`
                    <tr>
                        <td data-label="Identity"><input type="text" class="form-control"></td>
                        <td data-label="Key"><input type="text" class="form-control"></td>
                        <td data-label="Value"><input type="text" class="form-control rowValue"></td>
                        <td data-label="Actions"><button class="btn btn-danger deleteRow">Delete</button></td>
                    </tr>
                `);
                attachRowEvent();
            }

            function attachRowEvent() {
                $('.deleteRow').off('click').on('click', function () {
                    var tr = $(this).closest('tr');
                    tr.find('td').each(function () { $(this).find('input,span').css('text-decoration', 'line-through'); });
                    // Mark row as deleted by adding a data attribute
                    tr.data('deleted', 'true');
                    tr.find('input,button').attr('disabled', true);
                });
                $('.rowValue').off('focus').on('focus', function () { this.select(); });
            }

            // Helper Functions
            function getUrlParent(fullUrl) {
                try {
                    var url = new URL(fullUrl);
                    var baseUrl = url.origin;
                    var path = url.pathname;
                    if (path !== "" && !path.endsWith("/")) {
                        path = path.substring(0, path.lastIndexOf("/") + 1);
                    }
                    return baseUrl + path;
                } catch (e) {
                    return "";
                }
            }

            // Api url
            const apiUrl = getUrlParent(window.location.href) + 'tokens';

            // Request Functions
            function refreshData() {
                clearStatusMessage();
                $.get(apiUrl, function (data) {
                    $('#tokenTableBody').empty();
                    data.forEach(function (token) {
                        $('#tokenTableBody').append(`
                            <tr>
                                <td data-label="Identity"><span>${token.identity}</span></td>
                                <td data-label="Key"><span>${token.key}</span></td>
                                <td data-label="Value"><input type="text" class="form-control rowValue" value="${token.value}"></td>
                                <td data-label="Actions"><button class="btn btn-danger deleteRow">Delete</button></td>
                            </tr>
                        `);
                    });
                    attachRowEvent();
                }).fail(function (xhr, status, error) {
                    showStatusMessage('Refresh data error: ' + error, 'danger');
                });
            }

            function submitData() {
                clearStatusMessage();
                var data = [];
                $('#tokenTableBody tr').each(function () {
                    if ($(this).data('deleted'))
                        return;
                    if ($(this).find('span').length > 0) {
                        identity = $(this).find('span').eq(0).text();
                        key = $(this).find('span').eq(1).text();
                    } else {
                        identity = $(this).find('input').eq(0).val();
                        key = $(this).find('input').eq(1).val();
                    }
                    value = $(this).find('input').last().val();
                    data.push({ identity: identity, key: key, value: value });
                });
                $.ajax({
                    url: apiUrl,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (response) {
                        refreshData();
                        showStatusMessage(`Submit data successfully`, 'success');
                    },
                    error: function (xhr, status, error) {
                        showStatusMessage(`Submit data error: ` + error, 'danger');
                    }
                });
            }

            $(document).ready(function () {
                $('#refresh').click(refreshData);
                $('#submit').click(submitData);
                $('#addRow').click(addRow);

                // Automatically refresh data
                refreshData();
            });
        })();
    </script>
</body>
</html>
